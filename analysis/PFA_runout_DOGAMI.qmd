---
title: "PFA Debris-Flow Runout Analysis"
author: "Dan Miller"
format: 
  html:
    toc: true
    number-section: true
    highlight-style: github
date: April 24, 2023
editor: visual
params:
  output_dir:
    label: Output Directory
    value: c:/tempDir/out/
    input: text
  out_Rdata:
    label: Output Rdata file
    value: c:/work/data/pfa/runout_alpha25_L15_allTracks.Rdata
    input: text
  input_list:
    label: Text file containing a list of directories where the data files are found.
    value: c:/tempDir/in/DEMs/track_list.txt
    input: text
  scratch_dir:
    label: Scratch directory
    value: c:/work/scratch
    input: text
  all_tracks:
    label: Label all endpoint tracks as uncensored.
    value: TRUE
    input: text
editor_options: 
  chunk_output_type: console
bibliography: references.bib
---

```{r load, include = FALSE}
library(flexsurv)
library(survival)
library(TerrainWorksUtils)
library(terra)
library(stringr)
library(car)
library(ggplot2)
```

## Introduction: debris-flow runout

This document reports on an update and recalibration of the linked landslide initiation and debris-flow runout models used for the Private Forest Accord ([PFA](https://www.oregon.gov/odf/pages/private-forest-accord.aspx), [@odf2022]) steep-slopes modeling. These models were developed by Dan Miller and Kelly Burnett as described in Miller and Burnett [-@miller2007; -@miller2008] with application of the models described in Burnett and Miller [-@burnett2007]. The original models were calibrated using landslide-initiation locations, debris tracks, and "debris-torrent"-impacted channels that were field surveyed for the 1996 Storm Study by the Oregon Department of Forestry [@robison1999] and digitized to 10-meter line-trace DEM base maps. Several factors motivate a re-calibration and re-examination of these models. Recent work by the Oregon Department of Geology and Mineral Resources [@burns2022] now provides an inventory of landslide initiation points and debris-flow-runout tracks with a greater geographic and temporal range than available from the 1996 Storm Study; high-resolution DEMs derived from lidar are now available for much of Oregon (<https://www.oregongeology.org/lidar/>), and statistical methods and analysis tools have progressed considerably in the last 15 years.

The Miller-Burnett models identify the channels susceptible to direct impacts from debris flows originating upslope and delineate the source areas for those debris flows. Although the initiation and evolution of a landslide into a debris flow is a continuous process, the models examine landslide initiation and runout separately. This is because initiation and runout involve different sets of physical processes influenced by different sets of environmental factors. An empirical approach is used for both cases, in which statistical models are calibrated using observed landslide initiation sites and debris-flow tracks, but with the choice of predictor variables (also called the independent variables) based on current understanding of the physical processes involved. The models are linked in that the modeled potential for downslope impacts is a function of both initiation probability and runout probability. This document focuses on runout; a separate document describes the modeling done for landslide initiation.

Numerous studies have examined controls on debris-flow runout. Some specific to the Pacific Northwest include Benda and Cundy [-@benda1990]; Hofmeister et al. [-@hofmeister2002]; Fannin and Rollerson [-@fannin1993]; Robison et al. [-@robison1999]; May [-@may2002]; Lancaster et al. [-@lancaster2003]; Miller and Burnett [-@miller2008]; Guthrie et al. [-@guthrie2010]; Coe [-@coe2011], and Reid et al. [-@reid2016]. These and other studies consistently point to several factors that influence runout lengths:

-   channel gradient and confinement,

-   abrupt changes in flow direction at channel junctions,

-   the volume of mobilized material, and

-   the amount of large wood incorporated into the mobilized material.

Empirical models to predict runout length seek to calibrate observed runout lengths to measurements or estimates of these factors. Benda and Cundy [-@benda1990] used channel slope and tributary junction angles. Fannin and Wise [-@fannin2001] use channel gradient and confinement, estimated volume, and changes in flow direction. Miller and Burnett [-@miller2008] used channel gradient and confinement, estimated volume, tributary junction angles, and stand-age brackets (as indicators of large wood availability). Gurthie et al. [-@guthrie2010] used gradient, changes in flow direction, and presence/absence of mature timber. Reid et al. [-@reid2016] used estimated mobilized volume.

The Miller-Burnett models were developed for the Coastal Analysis and Modeling Study ([CLAMS](https://www.fsl.orst.edu/clams/)) specifically for characterizing potential debris-flow impacts to channels over the entire Oregon Coast Range. They were unique across modeling approaches in that they:

-   linked both probability of initiation and probability of runout to calculate probability of downslope impacts,

-   utilized digital elevation data to characterize topographic attributes point by point over potential runout paths,

-   characterized susceptibility in terms of the proportion of landslide initiation sites and debris-flow track length [see @burnett2007],

-   and could be run over large regional extents at the resolution of available DEMs.

Although modeling approaches have evolved since 2008 (see the discussion), the Miller-Burnett models continue to offer unique capabilities. In particular, they provide calculations of runout probability from every DEM cell with a nonzero probability of landslide initiation. This capability provided the means for two primary analyses used for the PFA steep-slope prescriptions:

1.  Delineation of nonfish-bearing channels that may be traversed by a debris-flow originating upslope and ranking these channels by the probability that a traversing debris flow will continue downstream and deliver material to a fish-bearing channel.

2.  Delineation of upslope source areas for debris flows that can travel to fish-bearing streams and ranking of those source areas in terms of the likely volume of material delivered.

Tracking all potential debris-flow tracks from every potential source is a huge computational task that this model handles through use of survival analysis [@kalbfleisch2002]. Survival analsyis is a statistical technique used extensively in medical and engineering analyses to quantify effects of environmental factors on expected lifespans and time to failure (e.g., of people or machine parts), but which had not been used previously for analysis of debris-flow runout. Miller and Burnett [-@miller2008] developed a survival-analysis approach in which the "lifespan" of a debris flow is measured in terms of runout distance, rather than time. This is a computationally efficient algorithm with which the runout probability for the many millions of potential initiation sites across a region can be calculated while accounting for environmental conditions point-by-point along each potential runout track.

Modeling tools for survival analysis have progressed since 2008. For this recalibration, we used the statistical language R (<https://www.r-project.org/>). Analyses with R are typically done using [R Packages](https://r-pkgs.org/), which provide a set of well-vetted programming tools for specific applications. We used the [survival](https://cran.r-project.org/web/packages/survival/survival.pdf) and [flexsurv](https://cran.r-project.org/web/packages/flexsurv/flexsurv.pdf) packages to calibrate a survival model for debris-flow runout. Details of this analysis, including the code, follow in subsequent sections.

## Survival Analysis

Empirical estimates of probable lifespan for individuals in a population are based on the distribution of lifespans measured for some sample from that population. Effects of factors that might influence lifespan are then evaluated by their effects on the shape of that distribution. Here, "lifespan" refers to the increment of time until some event of interest. In medical applications, this might involve the time that patients remain cancer free following different types of treatment. In engineering applications, this might involve how long until a machine part fails. In social applications, it might involve the length of time that a couple remains married as a function of income. See the introductory article by Emmert-Streib and Dehmer [-@emmert-streib2019] for other examples. A key aspect of survival analysis is the ability to incorporate "censured" data; that is, to use measured time spans for individuals in a sample for which the expected event does not occur prior to the end of the observation period.

Here we look at the "lifespan" of a debris flow, not in terms of time, but in terms of distance. We want to know the expected runout length as a function of environmental factors encountered along the runout path. We are interested in the factors listed in the introduction above: channel gradient and confinement, changes in flow direction, the volume of material mobilized, and the quantity of large woody debris incorporated.

### Survival Curves

A survival curve gives the proportion of individuals in a population that survive beyond a given time. It varies from zero to one on the y axis and 0 to the length of the period of observation on the x axis. A survival curve for debris flows indicates the proportion of events in a population of debris flows that runout beyond a given distance. An empirical estimate of the survival curve is obtained from the cumulative distribution of measured debris-flow-track lengths. For a given sample of debris-flow runout lengths, the survival curve is estimated as the proportion of tracks in the sample longer than a given length:

$$
S(x) \approx \frac{\# \: tracks \: longer \: than \: x}{N}
$$ {#eq-EmpSurv}

where $N$ is the total number of tracks [see @emmert-streib2019 for a concise description]. The shape of this distribution is determined by the probability that any individual debris flow will stop in the next interval of travel along its travel path. This probability is called the hazard rate and is defined as

$$
h(x) = \lim\limits_{\Delta x \to 0} \frac{P(x \leq X \lt x + \Delta x | X \geq x)}{\Delta x},
$$ {#eq-HazRate}

or estimated empirically as $h(x) \approx n / (x+\Delta x)$, where $x$ is distance from the initiating landslide and $n$ is the number of tracks with lengths between $x+\Delta x$. The cumulative hazard function $H$ "describes the accumulated risk up to time $t$" [@emmert-streib2019], or to distance $x$, and is defined as the integral of the hazard rate:

$$
H(x) = \int_0^x h(\tau)d\tau.
$$ {#eq-CumHaz}

The survival curve is then determined from the hazard rate as

$$
S(x) = \exp(-H(x)).
$$ {#eq-SurvCumH}

If the hazard rate is constant with distance, then the frequency distribution of track lengths will follow an exponential distribution. Remarkably, observed distributions of debris-flow travel lengths are fairly well approximated with an exponential distribution [@miller2008]. Other parametric distributions can also be used fit empirical survival curves [@emmert-streib2019]. For example, if the hazard rate increases or decreases with time (distance), the survival curve is described with a Weibull distribution. If the hazard rate follows a U-shaped curve, decreasing at first and then increasing, the survival curve can be described with a log-normal distribution. We expect that the hazard rate will vary with conditions along the travel path; that is, that the probability that a debris flow will continue through any increment of length along a potential travel path will vary with channel gradient and confinement, changes in flow direction, the volume of material mobilized, the amount of large woody debris, and other factors we have not yet considered. Thus, we expect the hazard rate to vary uniquely for every potential debris-flow track. We can use the shape of the empirical survival curve to infer how the hazard rate changes in response to these conditions. Measures of these conditions, e.g., of the gradient, are referred to as covariates (the independent variables) and the value of these covariates varies along the debris-flow travel path. To estimate the effect of these distance-varying covariates on the hazard rate, we use a relative risk model, typically referred to as a Cox model [@kalbfleisch2002, @emmert-streib2019], with time-varying (distance-varying in this case) covariates. The hazard rate is then defined as

$$
h(x,Z(x)) = h_0(x)\exp(\sum_{i=1}^p\beta_i Z(x)_i)
$$ {#eq-TimeVarh}

where $Z(x)$ is a vector of distance-varying covariates (e.g., gradient), $\beta$ is a vector of coefficients, one for each covariate, $p$ is the number of covariates, and $h_0(x)$ is a baseline hazard rate (i.e., the hazard rate when all the covariates $Z$ are zero). We fit the empirical survival curve, Equation @eq-EmpSurv, with a parametric distribution to define $h_0(x)$. Once values for the coefficients $\beta$ are estimated, the change in cumulative hazard function at any point $x$ along a potential debris-flow track is estimated as

$$
\Delta H(x|Z(x)) = 1 - (1-\Delta H_0(x))^ {\exp(x\beta(x))}
$$ {#eq-H_timeVar}

where $\Delta H_0$ is the baseline cumulative hazard function defined in Equation @eq-CumHaz using a parametric-distribution fit to the empirical survival curve [@kalbfleisch2002; @ruhe2018]. The survival curve is then determined as

$$
S(x|Z(x)) = \exp(-\sum_{i=1}^n \Delta H(x_i|Z(x_i)) ,
$$ {#eq-S_timeVar} where the $x_i$ are the locations where the covariates $Z(x_i)$ have been measured.

To obtain a baseline cumulative hazard function, we used the "flexSurv" R package to fit a parametric distribution to the debris-flow-track lengths measured from the DOGAMI Special Paper 53 inventory. We then used a variety of digital data products to obtain covariate values at intervals along each inventoried track. Descriptions of these covariates and how they were measured are provided in a following section. Tabulated values for all inventoried tracks were then used with the "survival" R package to obtain coefficient estimates for each covariate.

### Censored Data

An important capability of survival-analysis methods is the ability to use information from samples for which the event of interest is not observed. In this case, the event of interest is the terminal end point of a debris-flow deposit. This might occur when the distal end of a deposit has been removed by stream erosion or where the end of the deposit is not visible when mapped from aerial photographs. These cases still provide useful information because we know the debris flow traveled at least as far as the furthest point observable. Samples for which the event of interest - the terminal end of the debris-flow deposit - are not observed are referred to has being "censored". These censored samples are included with the uncensored samples, those for which the complete debris-flow track lengths are known, in estimating the survival curve. An empirical estimate of the survival curve based solely on the observed censored and uncensored flow-path lengths is obtained with the Kaplan-Meier estimate [@kalbfleisch2002, pg 16]:

$$
\hat{S}(x) = \prod_{j|x_j \leq x} \frac{n_j-d_j}{n_j}.
$$ {#eq-KaplanMeier}

Here, $n_j$ indicates the number of tracks in the sample with censored or uncensored lengths greater than $x_j$ and $d_j$ is the number of track terminal endpoints observed at $x_j$. Because changes in the $\hat{S}$ curve value occur only at lengths ($x$ values) corresponding to observed complete (uncensored) debris-flow tracks, the curve consists of a series of steps. The corresponding cumulative hazard function is obtained with the Nelson-Aalen estimate:

$$
\hat{H}_0(x) = \sum_{x_i \leq x} \frac{d_i}{n_i},
$$ {#eq-NelsonAalen}

The zero subscript indicates that this estimate can be used as the baseline cumulative hazard function for the relative-risk model (Equation @eq-TimeVarh), as it does not include the influence of any covariates.

### Determination of Flow Paths: Synthetic Channel Networks

Calibration and application of a survival model for debris-flow-track length requires ability to accurately trace debris-flow travel paths across surface topography, both for those debris flows that have been observed and for those that could occur at some time in the future. A DEM provides the elevation data with which to infer topographic controls on flow paths. For this, we apply the same algorithms used to trace surface flow paths for water by which a channel network is delineated. We refer to a channel network derived from DEM-traced flow paths as a "synthetic" network to distinguish it from a cartographic network traced from aerial photo interpretation. One component of the PFA analysis is to construct lidar-derived synthetic channel networks for Oregon and to classify these networks in terms of channel types (e.g., [fish or nonfish bearing](https://oregon.public.law/rules/oar_629-635-0200)) and riparian buffer requirements [@odf2022]. There are a variety of methods with an accompanying large literature for extracting channel networks from high-resolution DEMs. Review of that literature is beyond the scope of this document, but here I want to provide some details of the methods we use that will be helpful for understanding the landslide- and debris-flow-susceptibility analyses required for the PFA. A description of the methods initially developed for channel-network extraction with the CLAMS project is provided in Clarke et al. [-@clarke2008]. Additional details are provided in Miller et al. [@miller2015].

Three important factors in tracing a channel network from a DEM are:

1.  the choice of flow-direction algorithm,

2.  how closed depressions in the DEM are drained, and

3.  the criteria for determining the upslope extent of channels in the network.

#### Flow Direction

A DEM consists of a regular grid of elevation values. We interpret these as point measures of elevation at each grid point so that elevations between grid points can be estimated by interpolating from the neighboring grid-point values. Flow paths inferred from this grid of elevations are used to determine channel courses and traced upslope to estimate the contributing area to each point in a traced channel network. Flow paths traced from grid point to grid point offer eight options for flow direction; hence, an algorithm for determining which adjacent grid point to direct flow to is referred to as using a D-8 flow direction [@ocallaghan1984]. D-8 flow directions commonly follow the direction of steepest downslope gradient, although other topographic indicators can be used. For example, plan curvature is an indicator of contour-line crenulation, which is an indicator of presence of a channel, so directing flow to the adjacent downslope cell with the largest plan curvature can sometimes follow channel courses more accurately than using gradient alone [@clarke2008]. The directional bias imposed by D-8 flow directions likewise biases estimates of flow accumulation. Several algorithms have been developed that can parse flow out of a DEM cell, defined as the square area associated with each DEM point, into multiple downslope cells [@wilson]. These algorithms accommodate flow dispersion and therefore provide more accurate estimates of contributing area than obtained with D-8 flow directions. Of these multiple-flow-direction algorithms, the D-infinity algorithm introduced by Tarboton [@tarboton1997] generally provides the most accurate estimates of contributing area [@shelef2013]. Contributing area in unchannelized terrain is a key predictor for landslide initiation locations (discussed in a separate document) and for identifying the upslope channel extent. Hence, we use D-infinity flow directions for calculating contributing area. However, once a flow path traced downslope has entered a channel (as determined by the channel-initiation criteria), we want to preclude dispersion of flow downslope and use D-8 for tracing channelized flow paths. To calculate a survival curve along a debris-flow track, it must also follow a single track without dispersion; hence, debris-flow tracks across unchannelized terrain are also traced using D-8 flow directions. Once the traced path enters a delineated channel, it follows the channel course.

#### Closed Depressions

A DEM for any large area will invariably contain closed depressions. Some may be actual closed depressions in the terrain that have no surface outlet; others occur because of errors in the DEM or inability to resolve the outlet. For known closed depressions, we can allow surface drainage into the depression to essentially drain out at the low point in the depression, but more generally we want to identify the most likely outlet flow path. This may be a flow path for surface water or for shallow groundwater; either way, we want to account for water accumulated in the closed depression when calculating downslope contributing areas.

Closed depressions in DEMs were originally removed by filling the depression to the level of the lowest pour point [@jensonDomique1988]. However, this results in loss of topographic information for the area filled. Alternatives have been proposed [@wang2019] that seek to cut a flow path through the pour point, an approach referred to as "carving" [@soille2004]. With carving, flow paths within the depression are maintained, but a single flow path from the lowest point in the depression to the lowest pour point is identified for flow routing out of the depression. We use carving to drain closed depressions, with an algorithm following that of Barnes et al. [@barnes2014]. However, DEM elevations are used for a variety of subsequent calculations, such as estimates of gradient and curvature, so we do not actually alter any DEM values, but rather just record the flow paths identified for draining each closed depression.

#### Channel Initiation

With high-resolution DEMs, channels can potentially be resolved directly and the upslope extent determined using topographic indicators of channel presence, such as tangential curvature, topographic openness, and measures of local relief [e.g., @shavers2020]. We incorporate these measures for delineating channel extent; however, channels may not be resolved under forest canopy where lidar ground returns are sparse. Additionally, we want to extend delineated "channels" upslope into terrain prone to landslide initiation that may not be currently channelized. We therefore also use measures indicative of channel-forming-process rates to estimate the *potential* upslope extent for the mapped channel network. Contributing area provides an indicator of surface and shallow subsurface water flux during storms, so functions of contributing area and gradient are used as relative measures of erosion potential [e.g., @montgomery1993]. Clarke et al. [-@clarke2008] plotted modeled channel density as a function of a slope-area threshold for channel initiation to identify an inflection associated with the slope-area value at which modeled channels started to extend onto planar hillslopes (referred to as "feathering"). This inflection point shows the channel density resolvable with a DEM and varies with DEM resolution and with regional topography. We determine this inflection point separately for high- and low-gradient terrain (e.g., greater or less than 40% (\~22 degrees)) to account for the different processes of channel formation, e.g., debris-flow scour versus overland flow or seepage erosion. In steep terrain, the delineated synthetic channel network is extended upslope into unchannelized landforms, such as bedrock hollows, to include flow paths that can potentially serve as debris-flow corridors.

#### Data Structure

Geographic Information Systems (GIS) typically represent channel networks as a set of connected vector line segments. The code we use for these analyses is written primarily in Fortran and, internal to these programs, the channel network is represented as a [linked list](https://en.wikipedia.org/wiki/Linked_list) of channel nodes. Each node corresponds to a DEM grid point along the traced channel flow paths. The original D-8 flow directions produce jagged channel centerlines. These are smoothed over a length that varies with channel width to provide more accurate measures of channel length, so the channel-node locations are shifted from the DEM grid-point locations. Each node then represents a short channel segment with average lengths equal to the average spacing between DEM grid points along the traced flow path. Each node has an associated array of data fields. These include whatever information is required for the analyses to be performed on the channel network. For this debris-flow runout analysis, these data fields include topographic attributes (gradient, curvatures, contributing area, upslope flow length, etc.) and values extracted from other GIS data sources, such as stand age and rock type. Each node is linked to the adjacent up and downstream nodes, so that information can be efficiently routed through this network.

![Channel nodes](images/channelNodes.png){#fig-ChannelNodes fig-align-center="" fig-align="center" width="6in"}

The linked list of channel nodes is the data structure on which analyses involving channels and flow routing are done internally in the Fortran code. This allows us to maintain information associated with channels and flow paths at the spatial grain of the DEM. The results of any analysis can then be translated to a GIS file format, for which information can be summarized over larger spatial grains. For example, a vector shapefile of the channel network can be produced that includes summary information for each channel reach, such as the channel type and associated riparian buffer type and width.

Debris-flow travel paths are traced along nodes in the delineated channel network. However, the traced network does not extend upslope to all mapped or potential debris-flow-initiation sites. Through zones lacking associated channel nodes, flow paths are traced using unsmoothed D-8 flow directions from DEM grid point to grid point and any required attributes (e.g., gradient, curvature, stand age) are stored in temporary arrays.

## Probability of Debris-Flow Delivery and Traversal

Once coefficients $\beta(x)$ have been calibrated for a relative-risk survival model, a survival curve can be calculated along any potential flow path to provide the probability that a debris flow will travel to any downslope point along that path. For any debris-flow initiation site, the probability of runout to any location along the downslope flow path traced on the DEM is determined using Equations @eq-H_timeVar and @eq-S_timeVar. Any potential flow path may have multiple initiation sites that feed into it. Following Miller and Burnett [-@miller2008], the probability $P_{DF}$ that a debris-flow from any upslope initiation site will reach a point $x$ along that path is

$$
P_{DF}(x) = 1 - \prod_{i=1}^n(1-S_iP_{Ii})
$$ {#eq-MultiS}

where $S_i$ is the survival-curve value at point $x$ (from Equation @eq-S_timeVar) and $P_{Ii}$ the probability of initiation for the $i^{th}$ initiation site, with the product over all $n$ upslope initiation sites. The derivation of initiation probability $P_I$ is described in a separate document, but an example of the spatial distribution modeled for $P_I$ is shown in Figure @fig-InitProb below for a small drainage in the Siuslaw basin. To implement calculation of Equation @eq-MultiS over a DEM, surface-flow paths are traced from every DEM grid point with a nonzero initiation probability and @eq-MultiS calculated for every point along the flow path until the survival-curve value goes to zero.

![Modeled initiation probability for a small drainage in the Siuslaw basin. Black circles show landslide initiation sites from the DOGAMI inventory.](images/InitProb.jpg){#fig-InitProb fig-align="center" width="6in"}

The probability that a point in a nonfish channel is traversed by a debris flow that originates upslope and continues flowing downslope to deposit material into a fish-bearing channel is determined in a similar fashion [see @burnett2007]. The travel path from each DEM point with a nonzero probability of initiation is traced downslope until it intersects a fish-bearing channel. Label that intersection location as $x_F$. The probability calculated for that debris flow at that point of intersection is $S_i(x_F)P_{Ii}$, where $S_i(x_F)$ is the survival-curve value at $x_F$ and $P_{Ii}$ is the initiation probability for the $i^{th}$ DEM cell (where the flow path originated). $S_i(x_F)$ gives the probability that a debris flow from the $i^{th}$ DEM cell will travel to a fish-bearing channel. This value can be mapped back to the initiating DEM cell to create a map of delivery probabilities, an example of which is shown in Figure @fig-Deliv below. Note in Figure @fig-Deliv the extent of the debris-flow tracks from the DOGAMI inventory: all originated in areas with a low modeled probability of delivery and none of them extend to the fish-bearing channel.

![Probability of debris-flow delivery to a fish-bearing channel. The red lines show mapped debris-flow tracks from the DOGAMI inventory.](images/Delivery.jpg){#fig-Deliv fig-align="center" width="6in"}

The quantity $S_i(x_F)P_{Ii}$ gives the probability that a debris flow from the $i^{th}$ DEM cell delivers material to a fish-bearing channel. This value too can be mapped back to the DEM cell where each flow path originates to create a map showing the modeled probability that a debris flow will be initiated and travel to a fish-bearing stream, illustrated in Figure @fig-InitDeliv below.

![Probability of initiation and delivery to a fish-bearing channel.](images/init_and_deliv.jpg){#fig-InitDeliv fig-align="center" width="6in"}

That probability of initiation and delivery is also recorded for all the DEM cells along the flow path from the initiating cell to the intersection with the fish-bearing channel. This procedure is repeated for every DEM cell with nonzero initiation probability. For any cell along a flow path, the probability $P_T$ that it may be traversed by a debris flow originating from upslope that continued to a fish-bearing channel is then:

$$
P_T = 1 - \prod_{i=1}^n(1-S_i(x_F)P_i)
$$ {#eq-TravProb}

with the product performed for all $n$ upslope DEM cells with nonzero initiation probability. This value is calculated for all cells along all potential debris flow paths that intersect a fish-bearing channel. It can be translated back to each corresponding traversed DEM cell or channel node to generate a map of traversal probabilities. An example is shown in Figure @fig-DeliveryWeightedInit below. The probability of traversal increases as the number of upslope debris-flow source areas with potential delivery to the fish-bearing channel increases.

![Probability that a non-fish-bearing channel will be traversed by a debris flow that travels to a fish-bearing channel.](images/TravProb.jpg){#fig-DeliveryWeightedInit fig-align="center" width="6in"}

### Proportion of Debris-Flow Track Length

Equations @eq-MultiS and @eq-TravProb provide estimates for the probability of debris-flow impacts that can be calculated for all potential debris-flow travel paths. The models that provide these probabilities were calibrated against an observed set of landslide initiation sites and debris-flow tracks and thus reflect the spatial density of those features. A different inventory with a different number of events would have a different spatial density and produce different probabilities. Our interest, therefore, is not in the magnitude of these probabilities, but in the relative change in that magnitude from point to point. We also want a measure of that relative change that can be used to test the model on other landslide inventories.

Burnett and Miller [-@burnett2007] devised a strategy for accomplishing that. These probabilities both depend on the modeled probability of landslide initiation. In developing these models, we assumed that initiation events could be represented as a Poisson process, meaning that the location of any initiation site is independent of any other initiation site. The logistic regression model used to estimate probability of initiation therefore maintains the marginal probability of initiation locations, meaning that the integral of the modeled initiation probability over all potential initiation sites within the study area used to calibrate the model will equal the total number of observed initiation sites. In other words, that probability is proportional to the spatial landslide density (number of initiation sites per unit area). This probability is calculated for each DEM cell. Each DEM cell with nonzero initiation probability also has an associated downslope debris-flow travel path. Each DEM grid point or channel node along that path represents a short segment of that travel path. Each short segment has an associated probability that a debris flow will reach it based on @eq-MultiS and a probability that it will be traversed by a debris flow that continues to a fish-bearing channel based on @eq-TravProb. Just as integration of modeled initiation probability across the study area will return the total number of initiation sites, integration over all channels of the modeled probability that a debris flow will occur ($P_{DF}$ from Equation @eq-MultiS) will return a value proportional to the total observed debris-flow-track length within the study area and integration of the modeled probability of traversal by a debris flow that will continue to a fish-bearing stream ($P_T$ from Equation @eq-TravProb) will return a value proportional to the length of nonfish channels traversed by delivering debris flows observed within the study area.

The $P_{DF}$ and $P_T$ values are proportional to the spatial density of debris-flow tracks, measured as track length per unit channel length. As with the initiation sites, we can translate these probability values to the proportion of the total track length. The probability values are ranked from smallest to largest and summed to generate a cumulative frequency distribution of flow-path-segment lengths ordered by probability. The sum over all segments gives the total observed length of all debris-flow tracks or of those that intersected fish-bearing channels. The cumulative frequency distribution is then divided by the total track length to give a cumulative distribution. This distribution varies from zero to one and shows the proportion of observed track length as a function of modeled probability of debris-flow runout (Equation @eq-MultiS) or traversal (Equation @eq-TravProb). These ideas are illustrated in Figure @fig-TravPropGraph below for traversal probability modeled over the small drainage shown in the previous figures. The total nonfish channel length within this small subbasin that could be traversed by debris flows that continue to a fish-bearing stream is 18,167 meters. Integrating the modeled probability of traversal ($P_T$ Equation @eq-TravProb) over all these channels indicates a total expected length of traversed channels of 114 meters. Clearly, if any of the six mapped debris-flow tracks shown in Figure @fig-Deliv had reached a fish-bearing stream, it would be longer than that. Rather, the 114-meter value indicates the proportion of the total length of debris-flow-traversed channels included in the DOGAMI inventory that this subbasin is expected to contain based on the modeled initiation and delivery probabilities. The spatial variation in the modeled $P_{DF}$ value indicates which channels are more or less likely to have been traversed by a debris flow. In Figure @fig-TravPropGraph, the modeled probability of traversal is plotted along the x axis and the proportion of channel length on the y axis. The blue line is a cumulative distribution for all 18,167 meters of potentially traversed channels, showing what proportion of that channel length has a modeled probability less than or equal to the x-axis value. The orange line shows the cumulative integral over channel length of the modeled probability; this is the [expected value](https://en.wikipedia.org/wiki/Expected_value) (in a mathmatical sense) of debris-flow traversed channels, with a total length of 114 meters. By plotting the cumulative distributions, which vary from zero to one, we can compare how the total and expected debris-flow-traversed channel lengths vary as a function of modeled probability.

As described earlier, the magnitude of the modeled probability is problematic. It depends on the number of debris-flow tracks included in the inventory. Likewise, the distribution of channel lengths as a function of modeled probability will vary from sub-basin to sub-basin, depending on the distribution of topographic attributes unique to each sub-basin. As described by Burnett and Miller [-@burnett2007], use of proportions effectively normalizes these differences so that results can be compared directly between sites. The cumulative distribution shows how the proportion of channel length is distributed across the range of modeled probability values. Rather than mapping probability, we can map channels in terms of the proportion of expected debris-flow-traversed length. This is illustrated with the black lines and arrows in Figure @fig-TravPropGraph; each increment includes 20% of the modeled channel length.

![Proportion of channel length as a function of modeled traversal probability.](images/PropCurves.png){#fig-TravPropGraph alt="Proportion of channel length as a function of modeled traversal probability." fig-align="center" width="6in"}

These values can be mapped back to the traced flow paths. The flow paths can then be parsed into segments containing a specified proportion of the total track length, ordered from lowest probability to highest (or visa versa), as shown in Figure @fig-TravPropMap below. This is the methodology used to identify the "Debris-flow traversal area" and "Designated debris-flow traversal areas" defined for the PFA [@odf2022, pages 30-31].

![Nonfish channels colored in terms of the proportion of total traversed channel length.](images/TravProp.jpg){#fig-TravPropMap fig-align="center" width="6in"}

An important point with this approach is that the proportions calculated are relative to the total debris-flow-track length modeled within the area encompassed by the modeling. If a large basin contains regions with steep, debris-flow-prone terrain and with lower-gradient, less-debris-flow-prone terrain, the steep terrain will contain all of the high-proportion channels (i.e., the 80% to 100% channels in Figure @fig-TravPropMap) and the lower-gradient terrain will contain only the lower-proportion channels. However, if the modeling were done for the high- and low-gradient portions of the basin separately, then the lower-gradient terrain would contain channels in the high 80% to 100% values. This aspect with use of proportions renders the model outcomes sensitive to local and regional variations in debris-flow susceptibility. We assume that regional ecosystems have evolved to accommodate, even capitalize, on these variations. It is appropriate, therefore, to devise management guidelines that seek to maintain these patterns in debris-flow variability. This approach does that, but requires consideration of the appropriate spatial scale over which to maintain those patterns. For the PFA, this scale the [Hydrologic Unit Code](https://enviroatlas.epa.gov/enviroatlas/datafactsheets/pdf/Supplemental/HUC.pdf) 8 (HUC8) basin.

## Covariates

In the introduction, I listed some of the attributes associated with debris-flow runout distance in previous studies:

-   channel gradient and confinement,

-   abrupt changes in flow direction at channel junctions,

-   the volume of mobilized material, and

-   the amount of large wood incorporated into the mobilized material.

In this section, I will describe which of these we examined and how they were determined. Miller and Burnett [-@miller2008] overlaid debris tracks mapped and digitized by ODF for the 1996 Storm Study on DEMs and other GIS data to obtain measures of covariate values at points along the tracks. We do the same here, using tracks included in both the 1996-Storm-Study inventory and the DOGAMI inventory, but with lidar-derived DEMs. The digitized track paths do not follow the DEM-traced flow paths exactly. We used the following procedure to determine the DEM-traced flow path that corresponded most closely with the digitized path. A buffer was placed around each mapped track; 120 meters for the 1996 storm tracks and 20 meters for the DOGAMI tracks. These buffers were constrained so that they did not extend below the lowest elevation along the track. The 1996-Storm inventory included both vector lines (for debris paths) and points (for channel impacts). The points had variable spacing, with an average around 100 meters. The DOGAMI inventory had all tracks digitized as vector lines. The tracks do not all line up precisely with a mapped initiation point. To associate each point with a debris track, a DEM flow path was traced from each landslide initiation point included in the inventories. If this flow path intersected the track buffer within a specified flow length, 120 meters for the 1996 inventory; 50 meters for the DOGAMI inventory, it was assumed associated with that debris-flow track. The flow path was then traced from DEM point to point, or from channel node to channel node once the path intersected a channel delineated in the synthetic network, until is came to the bottom of the track buffer. All points and nodes from the initiation point to the end of the track buffer were assumed associated with that debris-flow track. Covariate values could then be measured at each DEM grid point or channel node along these traced tracks.

### Elevation Derivatives: Gradient and Curvature

The gradient of the slope or channel traversed by a debris flow and the degree to which topography constrains the width of the debris flow (the topographic confinement) are observed to influence runout length, with longer runout associated with steeper, more confined topography [e.g., @benda1990; @may2002; @guthrie2010]. We therefore want to measure gradient and confinement along each mapped or potential debris-flow track. Rather than measuring confinement directly, we use tangential curvature [@minár2020] as a measure of topographic confinement. Measures of gradient and curvature are scale dependent, in that measured values may vary depending on the length over which they are measured [@digital2010]. The degree of variability depends on the length scales over which elevations change. Measures of gradient and curvature should be made over the length scales associated with the processes and landforms of interest [@sîrbu2019]. Shallow landslide initiation scars and debris-flow-track widths are on the order of 10 meters [@robison1999]; the topographic controls on physical processes of landslide initiation, such as concentration of shallow groundwater flow, are probably somewhat larger than this. We measured gradient and curvature over a window of 7.5 meters radius.

### Volume Mass Balance

An important characteristic of channelized debris flows is their capacity to scour material from channel beds and banks and increase in volume as the flow downslope [@benda1990; @may2002]. A small soil failure high up a valley wall can thus evolve into an enormous, valley-burying debris flow. A model for debris-flow susceptibility must, therefore, identify those zones where debris flows can scour material and quantify the rate of volume increase [@reid2016]. Field surveys show that debris-flow scour tends to occur in steeper, more confined channels and deposition in lower-gradient, less confined channels [@benda1990; @fannin1993; @guthrie2010]. Miller and Burnett [-@miller2008] showed that field-surveyed zones of debris-flow scour, transitional flow (no net scour or deposition), and deposition [@robison1999] could be delineated from measures of gradient and confinement made on a 10-meter DEM. By assuming a constant bulking rate through zones of scour, they could then estimate debris-flow volume based on track length and the gradient and degree of confinement along the track. Additionally, because the cross-sectional area and areal extent of debris-flow deposits are related to total volume [@griswald2008], they could estimate the volume deposited through zones of deposition based on the total volume scoured and cross-sectional geometry of the flow path. Logically, the terminal end of a debris-flow deposit indicates the point where the volume scoured equals the volume deposited. Hence, Miller and Burnett used the ratio of the modeled volume deposited to volume scoured as a predictor variable that provided an integrated measure of conditions over the upslope portion of a debris-flow travel path. This is referred to as a volume mass balance approach [@guthrie2010].

#### Probability of Scour and Deposition

Precise delineation of zones where a debris flow has scoured or deposited material requires field surveys. Lidar differencing may provide an alternative for future studies [e.g., @bernard2021; @delong2022], but for this analysis the 1996 Storm Study [@robison1999] provides our only field-based delineation for zones of scour and deposition. This is the same data source used by Miller and Burnett [-@miller2008], but we now have high-resolution lidar elevation data for measuring topographic attributes. Miller and Burnett characterized gradient and confinement as a single-valued function; here we examine multiple attributes using [multinomial logistic regression](https://en.wikipedia.org/wiki/Multinomial_logistic_regression). From the DEM we calculated gradient, tangential curvature, and normal profile curvature over a 7.5-meter radius. Gradient and tangential curvature provide indications of steepness and topographic confinement. Profile curvature quantifies changes in downslope gradient and may prove helpful in assessing the effect of sudden reductions in slope steepness that can occur at tributary junctions.

Miller and Burnett [-@miller2008] also detected differences in potential for scour or deposition on forest age class, so we include an estimate of stand age based on data available from the Landscape Ecology, Modeling, Mapping and Analysis ([LEMMA](https://lemma.forestry.oregonstate.edu/)) project (the AGE_DOM attribute for 2017 available at <https://lemmadownload.forestry.oregonstate.edu/>), adjusted to give stand age in 1996). The three sites from the 1996 Storm Study with detailed mapping of debris--torrent impacts spanned a range of underlying rock types. We therefore included a simple classification of lithologic type as an independent variable to examine. The digitized debris-flow tracks and torrent impact points were overlain on the lidar DEMs and the corresponding flow paths traced as described above. Gradient, curvatures, stand age, and rock type were then recorded for each DEM grid point and channel node along the flow path, along with the survey classification as scour, transitional flow, or deposit. These provided the data inputs used with the [stats](https://stat.ethz.ch/R-manual/R-devel/library/stats/html/00Index.html) and [mlr3](https://mlr3.mlr-org.com/) packages in R for variable selection, model evaluation, and model calibration. The final model coefficients are then used in a Fortran subroutine to calculate probability of scour and deposition at all points along mapped and potential debris-flow tracks.

#### Scoured Volume: Bulking Rates and Soil Depth

Bulking rate refers to the increase in volume with debris-flow travel distance through zones of scour, measured as volume per unit length. Miller and Burnett [-@miller2008] assumed a constant bulking rate. Field-estimated values for western Oregon, however, span a range from near zero to over 24 m^3^/m. Benda [-@benda1990a] reports values of 5 to 10 m^3^/m of stored sediment within steep, debris-flow prone channels in the central Coast Range (Knowles Creek). May [-@may_MS1998] reports values from \< 1 m^3^/m to slightly over 12 m^3^/m for sites in the Siuslaw Basin. Stock and Dietrich [-@stock2006] report values from \< 1 m^3^/m to 7.5 m^3^/m. Reid et al. [-@reid2016] report values of 11 m^3^/m to 24 m^3^/m for sites in the Umpqua basin (they used DEM differencing, not field surveys). This range is not unexpected: the stored volume at a single site increases over time as material accumulates, only to be set back to zero when the next scouring debris flow passes [@dietrich1978; @may2003]. The volume available to be scoured depends in part on how much time has passed since the last debris flow. This is an essentially unknowable quantity for all potential debris-flow sites in Oregon, so the best we can do is to estimate a mean value for the population of sites.

However, field observations also indicate systematic spatial variation in rates of soil accumulation and accumulated colluvial soil depth, so we might provide some spatial context to an estimated mean value based on topographic attributes. Dietrich et al. [-@dietrich1982, figure 3] find that soil depths on planar slopes decrease systematically with increasing slope angle and that soil depths in convergent zones is considerably deeper with no apparent slope dependence. Patton et al. [-@patton2018, equation 1] find that measured soil thickness varies linearly with surface curvature:

$$
d = \frac{\Delta d}{\Delta\kappa}\kappa + \bar{d}
$$ {#eq-soilMean}

where $d$ is soil depth at a point, $\Delta d/\Delta \kappa$ is the rate of change in soil depth with change in curvature $\kappa$, and $\bar{d}$ is mean soil depth on a planar slope. They report values of $\Delta d / \Delta \kappa$ ranging from near zero to over 21 (with depth measured in meters and curvature as meter^-1^) and find that these values vary linearly with the standard deviation of curvature values measured over the areas analyzed. They used an ArcGIS function that measures curvature over a 9-cell window, using DEMs sampled to 5 meters. This is approximately equivalent to measuring over a 5-meter radius. They did not specify which curvature they used, but did indicate the calculation was based on the method presented by Zevenbergen and Thorne [-@zevenbergen1987], which should correspond to mean curvature ($(tangential + profile) \div 2$) calculated for a smooth surface fit to 9 points. We use Equation @eq-soilMean to estimate spatial variation in soil depth, with mean depth $\bar{d}$ set as a function of slope gradient $\theta$,

$$
\bar{d} = 1 - 0.84 \tan \theta
$$ {#eq-meanDepth}

based on a visual fit of the curve for the Rock Creek area in Dietrich et al. [-@dietrich1982]. We have no data for testing or calibrating the coefficients in these equations and did not, therefore, use the standard deviation in measured curvature values over a region to set the $\Delta d / \Delta \kappa$ value, as suggested by Patton et al. [-@patton2018]. Rather, we applied a constant value everywhere and set the $\Delta d/\Delta \kappa$ value so that the range of modeled bulking rates fell within the reported range. Use of Equations @eq-soilMean and @eq-meanDepth allow us to incorporate available topographic information and the consequent spatial variability in modeled soil depth into estimates of mean bulking rates. This is a rough measure, but it incorporates available information about topographic influences on soil depth more fully than assumption of a single constant bulking rate.

At any point along a debris-flow travel path, the volume scoured per unit length is estimated as a function of topography with Equations @eq-soilMean and @eq-meanDepth. The probability of scour is estimated as a function of topography, stand age, and rock type of the substrate using a logistic regression equation calibrated with the 1996-Storm survey data. The volume scoured over any increment $\Delta l$ of a debris-flow travel path is then estimated as

$$
\Delta V_S = P_S\bar{w}d\Delta l
$$ {#eq-scourVol}

where $P_S$ is the calculated probability of scour, $\bar{w}$ is average debris-flow-track width, and $d$ is soil depth calculated with Equations @eq-soilMean and @eq-meanDepth. The total modeled volume scoured at any point along a debris-flow track is then $\sum \Delta V_S$, with the sum over all upslope travel increments.

#### Deposited Volume

Iverson et al. [-@iverson1998] described scaling relationships between lahar volume and the resulting deposit cross-sectional and planimetric areas. Schilling [-@schilling1998] then implemented these relationships into a GIS program ([LAHARZ](https://data.usgs.gov/modelcatalog/model/5db1512e-7cfd-4916-9f97-d52528eadf75)) for mapping areas susceptible to inundation by a lahar. Subsequently, Griswold and Iverson [-@griswald2008] showed that similar scaling relationships hold for debris-flow and rock-fall deposits, reporting that the cross-sectional and planimetric area of a deposit is proportional to its volume taken to the two-thirds power. Miller and Burnett [-@miller2008] then used that relationship to constrain the volume of material deposited through zones of debris-flow deposition based on the total scoured volume. We follow a similar strategy here. The volume deposited over any incremental segment of a debris-flow track is assumed proportional to the total volume scoured up to that increment:

$$
\Delta V_D \propto P_D V_S^{2/3} \Delta l.
$$

Following Miller and Burnett [-@miller2008], we use the distribution of volume ratios ($V_D/V_S$) for debris-flow tracks in the inventory to set the constant of proportionality.

### Stand Age

### Substrate

## Model Calibration

### Data

DOGAMI Special Paper 53 Inventory

Focuses on debris-flow

Photo and lidar-shaded relief

### Probability of Scour and Deposition

ODF 1996 Storm Study survey data

Overlay with digital data

Predictors: Gradient, Tangential Curvature, Normal Profile Curvature, Stand Age, Geology

Multinomial logistic regression

### Baseline Survival Curve

Compare empirical distributions

Exponential, Weibull, and Log-Normal parametric distributions

### Survival Covariates

Volume Ratio - integrates conditions of upslope travel path.

Gradient, Tangential Curvature

Stand Age

### Delivered Volume

Distribution of volume-ratio volume values; setting alpha

## Results

This code chunk will assemble the data file if it doesn't already exist. This takes awhile.

```{r}

if (!file.exists(params$out_Rdata)) {
  
  output_dir <- params$output_dir
  if (!dir.exists(output_dir)) {
    dir.create(output_dir)
  }

  data_dir <- read.table(params$input_list, 
                         header = TRUE,
                         sep = ",")
  
  num_data_sets <- nrow(data_dir)
  num_tracks <- 0
  for (i in 1:num_data_sets) {
    tracks <- terra::vect(paste0(str_trim(data_dir[i,1]), "/DOGAMI_init.shp"))
    num_tracks <- num_tracks + nrow(tracks)
  }
  print(paste0("Number of data sets = ", num_data_sets))
  print(paste0("Total number of debris-flow tracks = ", num_tracks))
  
  radius <- 20.
  initRadius <- 50.
  length_scale <- 15.
  slope_intercept <- 1.0
  slope_coef <- -0.84
  bulk_coef <- 15.0
  init_width <- 15.0
  init_length <- 30.0
  DF_width <- 7.0
  alpha <- 0.25
  uncensored <- params$all_tracks
  data_file <- data.frame()

  for (i in 1:num_data_sets) {
    data_set_name <- str_trim(data_dir[i,2])
    DEM_file <- paste0(data_dir[i,1], "/elev_", data_set_name, ".flt")
    init_points <- paste0(data_dir[i,1], "/DOGAMI_init.shp")
    geo_poly <- paste0(data_dir[i,1], "/geoPoly_", data_set_name, ".shp")
    stand_age <- paste0(data_dir[i,1], "/standAge_", data_set_name, ".flt")
    tracks <- paste0(data_dir[i,1], "/DOGAMI_track.shp")
    
    these_data <- PFA_debris_flow(dem = DEM_file,
                                 init_points = init_points,
                                 geo_poly = geo_poly,
                                 stand_age = stand_age,
                                 tracks = tracks,
                                 radius = radius,
                                 initRadius = initRadius,
                                 length_scale = length_scale,
                                 slope_intercept = slope_intercept,
                                 slope_coef = slope_coef,
                                 bulk_coef = bulk_coef,
                                 init_width = init_width,
                                 init_length = init_length,
                                 DF_width = DF_width,
                                 alpha = alpha,
                                 uncensored,
                                 scratch_dir = params$scratch_dir)    
    
    n = ncol(these_data)
    these_data[ ,n+1] <- data_set_name
    summary(these_data)
    data_file <- rbind(data_file,these_data)
    if (i == 1) {
      out_points <- vect(paste0(params$scratch_dir, "/out_point.shp"))
    } else {
      new_points <- vect(paste0(params$scratch_dir, "/out_point.shp"))
      out_points <- rbind(out_points, new_points)
    }    
  }
  save(data_file, file = "c:/work/data/pfa/runout_alpha25_L15_allTracks.Rdata")
  writeVector(out_points,file = "c:/work/data/pfa/init_alpha25_L15_allTracks.shp", overwrite = TRUE)
}
```

Load the saved data file. We use the logarithm of the VolRatio values, so remove all zero records. And, GeoClass needs to be recognized as a factor.

```{r}
load(params$out_Rdata)
keep <- which(data_file$VolRatio > 0.)
data_file <- data_file[keep,]
data_file$GeoClass <- as.factor(data_file$GeoClass)
summary(data_file)
```

The VolRatio field is the ratio of the modeled deposited volume (DepVol) to scoured volume (ScourVol): VolRatio = DepVol/ScourVol. the scoured volume is initially assigned an initiating landslide volume and then grows through zones where the modeled probability of scour is greater than zero as the debris flow progresses downslope. The deposited volume increases through zones where the modeled probability of deposition is greater than zero. (See PFA_runout.qmd for a description of how probability of scour and deposition were determined). The deposited volume is proportional to the scoured volume taken to the two thirds power. This is based on the LAHARZ model [@griswald2008], for which the cross-sectional area of a debris-flow deposit is found to be proportional to the total deposit volume taken to the two thirds power. Here we assume that the cross-sectional area of deposited material is proportional to the total scoured volume to that point. Thus the volume ratio indicates conditions along the upslope debris-flow track. We assume that the probability for a debris flow to continue through any increment of travel (one minus the hazard rate) varies with the volume ratio. We also assume that the probability might vary with conditions at each point along the travel path; particularly gradient, tangent curvature, stand age, and rock type. Changes in flow direction may also pose a good candidate, but I did not include it here for technical issues I haven't yet solved.

Each mapped debris-flow track is parsed into segments corresponding to channel-node segments, or DEM cell segments upslope of the channel initiation points. Each segment is associated with a VolRatio, gradient, tangential curvature, stand age, and rock-type value. The last segment along a track that does not intersect any other track is recognized as an end point.

Here is the cumulative distribution of complete (nontruncated) runout lengths, along with two other sets of runout lengths collected over more localized regions. The Knowles Creek values come from Lee Benda's Masters Thesis and the Hoffman Creek values from Landcaster et al. [@lancaster2003].

```{r}
benda <- c(220,240,240,240,240,280,312,380,400,416,418,432,450,480,480,480,510,554,600,600,600,600,600,602,625,648,720,780,810,840,875,880,880,960,1000,1085,1120,1200,1200,1300,1300,1400,1485,1500)
benda_thesis <- as.data.frame(benda)
benda_thesis[ ,2] = 1
benda_thesis[ ,3] = "Knowles"
colnames(benda_thesis)[1] = "Tend" # for consistency
colnames(benda_thesis)[2] = "Death"
colnames(benda_thesis)[3] = "Origin"

HoffmanCr <- c(30,30,50,60,60,80,100,100,100,110,120,120,130,150,150,150,170,180,200,209,210,300,310,350,420,430,480,560,680)
HoffmanCr <- as.data.frame(HoffmanCr)
HoffmanCr[ ,2] = 1
HoffmanCr[ ,3] = "Hoffman"
colnames(HoffmanCr)[1] = "Tend"
colnames(HoffmanCr)[2] = "Death"
colnames(HoffmanCr)[3] = "Origin"

keep <- which(data_file$Death == 1)
dogami <- data_file[keep,]
dogami <- dogami[,-1:-2]
dogami <- dogami[,-2:-9]
dogami[ ,3] = "DOGAMI"
colnames(dogami)[3] = "Origin"

alltracks <- rbind(dogami,HoffmanCr,benda_thesis)

ggplot(data = alltracks, aes(x = Tend, y = 1 - ..y.., fill = Origin)) + 
  coord_cartesian(xlim = c(0,2000)) +
  stat_ecdf(geom = "point", shape = 21, size = 3, alpha = 0.5, pad = FALSE) +
  xlab("Debris-Flow Track Length (m)") +
  ylab("Proportion Less Than")

```

Why such different results? The Knowles Creek and Hoffman Creek data represent debris flows from within single basins, whereas the DOGAMI data are for debris flows across western Oregon. The distributions of hillslope length and gradient likely influence the distribution of debris-flow-track lengths, so topographic variability across basins may result in different distributions of debris-flow length. We are using the DOGAMI data to provide a regional average distribution of debris-flow lengths. We will

The DOGAMI track-length distribution is very right skewed, shown in this histogram.

```{r}
keep <- which(data_file$Death == 1)
tracks <- data_file[keep,]
ggplot(data=tracks, aes(x = Tend)) + labs(x = "Track Length (m)") + 
  geom_histogram(binwidth = 50, color = "black", fill = "gray", )
```

Most tracks are relatively short and only a handful are greater than 2000 meters.

```{r}
densityPlot(log(tracks$Tend))
```

The log of track lengths is nearly normally distributed, suggesting a log-normal distribution. We can use flexsurvreg to fit a parametric baseline survival function to the distribution of track lengths. I'll only plot up to 2000m..

```{r}
fit_lognorm <- flexsurvreg(Surv(Tend,Death)~1, data = tracks, dist = "lognormal")
fit_lognorm
plot(fit_lognorm, xlab = "Track Length (m)", ylab = "Probability of Survival", xlim = c(0, 2000))
plot(fit_lognorm, type = "hazard", xlab = "Track Length (m)", xlim = c(0, 2000), ylim = c(0, 0.0025))
```

The empirical hazard rate increases rapidly up to about 200m and then decreases. I cannot come up with a physical explanation. Here's how an exponential distribution fits:

```{r}
fit_exp <- flexsurvreg(Surv(Tend,Death)~1, data = tracks, dist = "exponential")
fit_exp
plot(fit_exp, xlab = "Track Length (m)", ylab = "Probability of Survival", xlim = c(0, 2000))
plot(fit_exp, xlab = "Track Length (m)", type = "hazard", xlim = c(0, 2000))
```

Log normal is clearly a better fit. We'll use that for the baseline survival function.
